<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Integer Add/Subtract – Vectors</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 18px;

      --line:#111827;
      --tick:#111827;

      --pos:#16a34a; /* green */
      --neg:#dc2626; /* red  */
      --eq:#2563eb;  /* blue for = result */
      --hi:#fde68a;  /* yellow highlight */

      --haloFill: rgba(22,163,74,.18);
      --haloStroke: rgba(22,163,74,.45);

      --footer-h: 44px;
      --animMs: 2000;

      /* arrows */
      --arrowW: 4;
      --dash: 16;
      --gap: 14;

      --headW: 6;
      --headH: 6;

      --pad: 3;

      /* quick dial for PNG size */
      --personW: 92px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--ink);
      padding-bottom: var(--footer-h);
    }

    .wrap{ max-width: 1100px; margin: 22px auto 40px; padding: 0 16px; }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 14px;
      position: relative;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }

    .brandBack{
      display:inline-flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color: var(--ink);
      font-weight: 950;
      border: 1px solid var(--border);
      background:#fff;
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
      user-select:none;
      white-space: nowrap;
    }
    .brandBack img{ height: 26px; width:auto; display:block; }
    .brandBack span{ font-size: 13px; letter-spacing:.1px; }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    button{
      border:none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      background:#f3f4f6;
      color:#111827;
      transition: transform .04s ease, filter .15s ease, opacity .2s ease;
      user-select:none;
    }
    button:active{ transform: scale(.98); }
    button.primary{ background: #2563eb; color:#fff; }
    button.danger{ background:#fee2e2; color:#991b1b; }

    /* tools dropdown */
    .menuWrap{ position:relative; display:inline-block; }
    .menuBtn{
      background:#f3f4f6;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 950;
    }
    .menuBtn:after{ content:""; }
    .menu{
      position:absolute;
      right:0;
      top: calc(100% + 10px);
      width: 260px;
      background:#fff;
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.12);
      padding: 10px;
      display:none;
      z-index: 50;
    }
    .menu.show{ display:block; }
    .menu .hint{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      padding: 8px 10px 4px;
    }
    .menu a{
      display:block;
      padding: 12px 10px;
      border-radius: 12px;
      text-decoration:none;
      color: var(--ink);
      font-weight: 950;
    }
    .menu a:hover{ background:#f3f4f6; }

    /* teacher settings */
    .settingsWrap{ position:relative; display:inline-block; }
    .settingsBtn{
      background:#f3f4f6;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 950;
    }
    .settingsPanel{
      position:absolute;
      right:0;
      top: calc(100% + 10px);
      width: 320px;
      background:#fff;
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.12);
      padding: 12px;
      display:none;
      z-index: 60;
    }
    .settingsPanel.show{ display:block; }
    .settingsTitle{
      font-size: 13px;
      font-weight: 950;
      color: var(--muted);
      margin: 2px 0 10px;
    }
    .radioRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      border-radius: 12px;
      cursor:pointer;
      user-select:none;
    }
    .radioRow:hover{ background:#f3f4f6; }
    .radioRow input{ transform: scale(1.05); }
    .radioRow .name{ font-weight: 950; }
    .radioRow .desc{
      font-size: 12px;
      color: var(--muted);
      font-weight: 850;
      margin-top: 2px;
      line-height: 1.2;
    }
    .radioCol{ display:flex; flex-direction:column; gap:2px; }

    .qRowUnder{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      margin: 8px 0 10px;
      flex-wrap:wrap;
    }
    .qLabel{
      font-weight: 950;
      color: var(--ink);
      font-size: 16px;
      white-space: nowrap;
    }
    .qBox{
      border: 2px solid #111827;
      border-radius: 16px;
      padding: 10px 14px;
      font-weight: 950;
      font-size: 26px;
      letter-spacing: .2px;
      background:#fff;
      min-width: 240px;
      text-align:center;
      line-height: 1.15;
    }

    .qLine{ display:block; margin: 0; }
    .qLine.small{
      margin-top: 8px;
      font-size: 22px;
      opacity: 0;
      transform: translateY(-4px);
      transition: opacity .18s ease, transform .18s ease;
      font-weight: 950;
    }
    .qLine.small.show{
      opacity: 1;
      transform: translateY(0);
    }

    .hl{
      background: var(--hi);
      border-radius: 10px;
      padding: 2px 6px;
      display:inline-block;
    }
    .eq{ color: var(--eq); font-weight: 950; }
    .ansPill{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--haloFill);
      color: #065f2c;
      font-weight: 950;
      border: 2px solid var(--haloStroke);
    }
    .ansPill.big{
      font-size: 30px;
      padding: 4px 10px;
    }

    .stage{
      margin-top: 8px;
      padding: 12px 12px 18px;
      border-radius: 16px;
      background: linear-gradient(180deg,#ffffff, #f9fafb);
      border: 1px solid #e5e7eb;
      overflow:hidden;
      position: relative;
      min-height: 540px;
    }

    .svgwrap{ width:100%; height: 440px; display:block; }

    .personLayer{
      position:absolute;
      left:0; top:0; right:0; bottom:0;
      pointer-events:none;
    }
    .person{
      position:absolute;
      width: var(--personW);
      height: auto;
      transform: translate(-50%, -50%);
      top: 120px;
      left: 50%;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.12));
      image-rendering: auto;
    }

    .stageActions{
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 14px;
      display:flex;
      justify-content:center;
      gap: 18px;
      pointer-events:none;
    }
    .navBtn{
      pointer-events:auto;
      border-radius: 999px;
      padding: 12px 18px;
      font-weight: 950;
      box-shadow: 0 12px 24px rgba(0,0,0,.10);
      min-width: 60px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }
    .navBtn[disabled]{ opacity: .45; cursor:not-allowed; transform:none; }

    .hintRow{
      margin-top: 10px;
      text-align:center;
      font-size: 12px;
      color: var(--muted);
      font-weight: 850;
    }

    .mmtFooter{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: var(--footer-h);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 12px;
      background: rgba(255,255,255,.92);
      border-top: 1px solid rgba(229,231,235,.95);
      backdrop-filter: blur(8px);
      z-index: 500;
      font-weight: 900;
      color: #111827;
      text-align:center;
      font-size: 13px;
    }
    .mmtFooter a{ color: #2563eb; text-decoration:none; font-weight: 950; }
    .mmtFooter a:hover{ text-decoration: underline; }

    .baseline{ stroke: var(--line); stroke-width: 7; stroke-linecap: round; }
    .tickMajor{ stroke: var(--tick); stroke-width: 7; stroke-linecap: round; }
    .tickUnit{
      stroke: rgba(17,24,39,.40);
      stroke-width: 3;
      stroke-linecap: round;
      opacity: 1;
    }

    .dot{ fill: #111827; opacity: 0.92; }
    .dot.zero{ opacity: 0.85; }

    .label{
      font-size: 26px;
      font-weight: 950;
      fill: #111827;
    }
    .label.answer{
      font-size: 28px;
      fill: #0b3b1a;
    }

    .arrowPath{
      fill: none;
      stroke-width: var(--arrowW);
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: var(--dash) var(--gap);
    }
    .arrowLabel{
      font-size: 30px;
      font-weight: 950;
    }

    .trackerDot{
      fill: #111827;
      opacity: 0;
      transition: opacity .12s ease;
    }

    /* SVG halo */
    .ansHalo{
      fill: var(--haloFill);
      stroke: var(--haloStroke);
      stroke-width: 6;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <a class="brandBack" href="https://www.millsmathstools.au" aria-label="Back to Mills Maths Tools">
          <img src="mmt.png" alt="MMT logo">
          <span>Back to Mills Maths Tools</span>
        </a>

        <div class="btnrow">
          <div class="menuWrap">
            <button id="toolsBtn" class="menuBtn" title="Tools">Tools ▲</button>
            <div id="toolsMenu" class="menu" role="menu" aria-label="Tools menu">
              <div class="hint">Open in a new tab</div>
              <a id="studentQuizLink" href="student-quiz.html" target="_blank" rel="noopener">Student Quiz</a>
              <a id="worksheetLink" href="worksheet-creator.html" target="_blank" rel="noopener">Worksheet Creator</a>
            </div>
          </div>

          <div class="settingsWrap">
            <button id="settingsBtn" class="settingsBtn" title="Teacher settings">Teacher settings</button>
            <div id="settingsPanel" class="settingsPanel" aria-label="Teacher settings panel">
              <div class="settingsTitle">Difficulty</div>

              <label class="radioRow">
                <input type="radio" name="diff" value="sweet" checked />
                <div class="radioCol">
                  <div class="name">Sweet</div>
                  <div class="desc">Default range (−20 to 20)</div>
                </div>
              </label>

              <label class="radioRow">
                <input type="radio" name="diff" value="mild" />
                <div class="radioCol">
                  <div class="name">Mild</div>
                  <div class="desc">Extend range (−50 to 50)</div>
                </div>
              </label>

              <label class="radioRow">
                <input type="radio" name="diff" value="medium" />
                <div class="radioCol">
                  <div class="name">Medium</div>
                  <div class="desc">Extend range (−100 to 100)</div>
                </div>
              </label>

              <label class="radioRow">
                <input type="radio" name="diff" value="spicy" />
                <div class="radioCol">
                  <div class="name">Spicy</div>
                  <div class="desc">Range (−100 to 100), 0.5 steps (1dp display)</div>
                </div>
              </label>
            </div>
          </div>

          <button id="resetBtn" class="danger" title="Reset (R)">Reset</button>
          <button id="newBtn" class="primary" title="New question (Space)">New Q</button>
        </div>
      </div>

      <div class="qRowUnder" aria-label="Question">
        <div class="qLabel">Question:</div>
        <div id="qBox" class="qBox">
          <span id="qMain" class="qLine">—</span>
          <span id="qSimpl" class="qLine small">—</span>
        </div>
      </div>

      <div class="stage">
        <svg id="svg" class="svgwrap" viewBox="0 0 1000 440" role="img" aria-label="number line"></svg>

        <div class="personLayer">
          <img id="personImg" class="person" src="still.png" alt="person">
        </div>

        <div class="stageActions">
          <button id="backBtn" class="navBtn" title="Back (←)" aria-label="Back">◀</button>
          <button id="fwdBtn" class="navBtn primary" title="Forward (→ / Enter)" aria-label="Forward">▶</button>
        </div>
      </div>

      <div class="hintRow">
        Shortcuts: ← / → step · Enter = skip/next · Space = New Q · R = Reset
      </div>
    </div>
  </div>

  <div class="mmtFooter">
    This tool and more can be found at&nbsp;
    <a href="https://www.millsmathstools.au">www.millsmathstools.au</a>
  </div>

<script>
(() => {
  // ----- difficulty presets -----
  const PRESETS = {
    sweet:  { min:-20,  max: 20,  spicy:false },
    mild:   { min:-50,  max: 50,  spicy:false },
    medium: { min:-100, max:100,  spicy:false },
    spicy:  { min:-100, max:100,  spicy:true  } // 0.5 steps, 1dp display
  };

  let presetKey = "sweet";
  let MIN = PRESETS[presetKey].min;
  let MAX = PRESETS[presetKey].max;
  const PAD = 3;

  const ANIM_MS = 2000;

  // Cache-bust querystring to help with "live but stale" sprite loads
  const ASSET_V = "v=1";

  const SPRITES = {
    still: `still.png?${ASSET_V}`,
    right: [`walk-right-1.png?${ASSET_V}`, `walk-right-2.png?${ASSET_V}`],
    left:  [`walk-left-1.png?${ASSET_V}`,  `walk-left-2.png?${ASSET_V}`]
  };

  const svg = document.getElementById("svg");
  const qMain = document.getElementById("qMain");
  const qSimpl = document.getElementById("qSimpl");

  const personImg = document.getElementById("personImg");

  const newBtn = document.getElementById("newBtn");
  const resetBtn = document.getElementById("resetBtn");
  const backBtn = document.getElementById("backBtn");
  const fwdBtn  = document.getElementById("fwdBtn");

  const toolsBtn = document.getElementById("toolsBtn");
  const toolsMenu = document.getElementById("toolsMenu");
  const settingsBtn = document.getElementById("settingsBtn");
  const settingsPanel = document.getElementById("settingsPanel");

  const abs = Math.abs;
  const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));

  function clearSVG(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

  function el(name, attrs={}, children=[]){
    const n = document.createElementNS("http://www.w3.org/2000/svg", name);
    for (const [k,v] of Object.entries(attrs)) n.setAttribute(k, String(v));
    for (const c of children) n.appendChild(c);
    return n;
  }
  function textNode(str, attrs={}){
    const t = el("text", attrs);
    t.textContent = str;
    return t;
  }

  function fmtSignedVector(n){
    // keep negative sign on negatives; positives shown without "+"
    // NOTE: when spicy, n will be in 0.5 steps; display 1dp
    if (PRESETS[presetKey].spicy){
      const s = (Math.round(n*2)/2).toFixed(1);
      return (n < 0) ? String(s) : String(abs(n).toFixed(1));
    }
    return (n < 0) ? String(n) : String(abs(n));
  }

  function fmtNumber(n){
    if (PRESETS[presetKey].spicy){
      return (Math.round(n*2)/2).toFixed(1);
    }
    return String(n);
  }

  function questionHTML(a, op, b, highlightPart){
    const opChar = (op === "+") ? "+" : "−";
    const aStr = fmtNumber(a);
    const bStr = (b < 0) ? `(${fmtNumber(b)})` : `(+${fmtNumber(b)})`;
    const wrap = (txt, which) => (highlightPart === which) ? `<span class="hl">${txt}</span>` : txt;
    return `${wrap(aStr,"a")} ${wrap(opChar,"op")} ${wrap(bStr,"b")}`;
  }

  function setPersonStill(){ personImg.src = SPRITES.still; }
  function setPersonStaticFacingByOp(op){
    personImg.src = (op === "+") ? SPRITES.right[0] : SPRITES.left[0];
  }
  function spriteFramesForDirection(dir){
    return (dir === "+") ? SPRITES.right : SPRITES.left;
  }
  function setPersonX(viewX){
    const pct = (viewX / 1000) * 100;
    personImg.style.left = pct + "%";
  }

  // pre-load sprites to reduce "sliding still" / missing alternation on first run
  function preloadSprites(){
    const urls = [SPRITES.still, ...SPRITES.right, ...SPRITES.left];
    urls.forEach(u => { const im = new Image(); im.src = u; });
  }

  // ---- Enter-to-skip animation ----
  let isAnimating = false;
  let animToken = null;
  function beginAnimToken(){
    animToken = { skip:false };
    isAnimating = true;
    return animToken;
  }
  function endAnimToken(){
    isAnimating = false;
    animToken = null;
  }
  function requestSkip(){
    if (animToken) animToken.skip = true;
  }

  let walkingTimer = null;
  function stopWalking(){
    if (walkingTimer) { clearInterval(walkingTimer); walkingTimer = null; }
  }
  function startWalking(spriteDir){
    stopWalking();
    const frames = spriteFramesForDirection(spriteDir);
    let i = 0;
    personImg.src = frames[0];
    walkingTimer = setInterval(() => {
      i = (i + 1) % frames.length;
      personImg.src = frames[i];
    }, 220);
  }

  // ----- question + scene state -----
  let Q = null;
  let stepState = 0;  // 0,1,2,3,4
  let refs = null;

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function randHalf(min,max){
    // multiples of 0.5
    const a = Math.round(min*2);
    const b = Math.round(max*2);
    return (randInt(a,b))/2;
  }
  function nonZeroRand(){
    for (let i=0;i<5000;i++){
      const v = PRESETS[presetKey].spicy ? randHalf(MIN,MAX) : randInt(MIN,MAX);
      if (v !== 0) return v;
    }
    return PRESETS[presetKey].spicy ? 0.5 : 1;
  }

  function generateQuestion(){
    for (let tries=0; tries<8000; tries++){
      const a = nonZeroRand();
      const b = nonZeroRand();
      const op = (Math.random() < 0.5) ? "+" : "-";
      const res = (op === "+") ? (a + b) : (a - b);
      if (res < MIN || res > MAX) continue;
      return { a, b, op, res };
    }
    return { a: 5, b: -3, op: "+", res: 2 };
  }

  function computeViewRange(a, res){
    const lo = Math.min(0, a, res) - PAD;
    const hi = Math.max(0, a, res) + PAD;
    return { vmin: clamp(lo, MIN, MAX), vmax: clamp(hi, MIN, MAX) };
  }

  function buildScene(){
    clearSVG();
    refs = null;

    const { a, b, op, res } = Q;
    const { vmin, vmax } = computeViewRange(a, res);

    const left = 80, right = 920;

    const yLine = 325;
    const tickTop = yLine - 22;
    const yArrow1 = tickTop - 42;
    const yArrow2 = yArrow1 - 58;

    const tickBot = yLine + 22;
    const dotR = 10;
    const labelY = 405;

    // ✅ halo + label centering "dial"
    const HALO_Y = labelY - 18;

    const x = (v) => {
      const t = (v - vmin) / (vmax - vmin);
      return left + t * (right - left);
    };

    const defs = el("defs");

    const mkEnd = el("marker",{
      id:"arrowHeadSmall",
      markerWidth:"6",
      markerHeight:"6",
      refX:"6",
      refY:"3",
      orient:"auto",
      markerUnits:"strokeWidth",
      viewBox:"0 0 6 6"
    },[
      el("path",{ d:"M 0 0 L 6 3 L 0 6 z", fill:"currentColor" })
    ]);

    const mkStart = el("marker",{
      id:"arrowHeadStart",
      markerWidth:"6",
      markerHeight:"6",
      refX:"0",
      refY:"3",
      orient:"auto",
      markerUnits:"strokeWidth",
      viewBox:"0 0 6 6"
    },[
      el("path",{ d:"M 6 0 L 0 3 L 6 6 z", fill:"currentColor" })
    ]);

    defs.appendChild(mkEnd);
    defs.appendChild(mkStart);
    svg.appendChild(defs);

    svg.appendChild(el("line", { x1:left, y1:yLine, x2:right, y2:yLine, class:"baseline" }));

    const gTicks = el("g");
    const gUnit  = el("g");
    const gArrows= el("g");
    const gHalo  = el("g");

    function addMajor(val, dotClass, extraTextClass=""){
      const xi = x(val);
      gTicks.appendChild(el("line",{ x1:xi, y1:tickTop, x2:xi, y2:tickBot, class:"tickMajor" }));
      gTicks.appendChild(el("circle",{ cx:xi, cy:yLine, r:dotR, class:`dot ${dotClass||""}`.trim() }));

      // ✅ label is vertically centered now
      const t = textNode(fmtNumber(val), {
        x: xi,
        y: HALO_Y,
        "text-anchor":"middle",
        "dominant-baseline":"middle",
        class: ("label " + extraTextClass).trim()
      });
      gTicks.appendChild(t);

      return { x: xi, val, textNode: t };
    }

    // unit ticks
    const step = PRESETS[presetKey].spicy ? 0.5 : 1;
    for (let v = Math.ceil(vmin/step)*step; v <= Math.floor(vmax/step)*step + 1e-9; v += step){
      if (Math.abs(v) < 1e-9) continue;
      const xi = x(v);
      gUnit.appendChild(el("line", { x1:xi, y1:yLine-12, x2:xi, y2:yLine+12, class:"tickUnit" }));
    }

    svg.appendChild(gUnit);
    svg.appendChild(gTicks);

    const zeroNode = addMajor(0, "zero");

    function makeArrow(x1, x2, y, color, labelText, headSide="end"){
      const attrs = { x1, y1:y, x2:x1, y2:y, class:"arrowPath" };
      if (headSide === "start") attrs["marker-start"] = "url(#arrowHeadStart)";
      else attrs["marker-end"] = "url(#arrowHeadSmall)";

      const path = el("line", attrs);
      path.style.stroke = color;
      path.style.color  = color;
      path.style.display = "none";

      const lx = (x1 + x2) / 2;
      const ly = y - 18;
      const label = textNode(labelText, { x:lx, y:ly, "text-anchor":"middle", class:"arrowLabel" });
      label.style.fill = color;
      label.style.display = "none";

      const tip = el("circle",{ cx:x1, cy:y, r:"6", class:"trackerDot" });
      tip.style.display = "none";

      gArrows.appendChild(path);
      gArrows.appendChild(label);
      gArrows.appendChild(tip);

      return { path, label, tip, x1, x2, y, color, headSide };
    }

    const x0 = x(0);
    const xA = x(a);
    const xR = x(res);

    const colA = (a >= 0) ? "var(--pos)" : "var(--neg)";
    const colB = (b >= 0) ? "var(--pos)" : "var(--neg)";

    const disp2 = (op === "+") ? b : -b;
    const xEnd2 = x(a + disp2);

    const arrowA = makeArrow(x0, xA, yArrow1, colA, fmtSignedVector(a), "end");

    // subtraction ALWAYS reverses the arrowhead
    const headSideB = (op === "-") ? "start" : "end";
    const arrowB = makeArrow(xA, xEnd2, yArrow2, colB, fmtSignedVector(b), headSideB);

    svg.appendChild(gArrows);

    // majors for a and result
    const aNode  = addMajor(a, "", "");
    const resNode = addMajor(res, "", "answer");

    // ✅ halo around answer label (hidden until final reveal)
    const halo = el("circle", {
      cx: xR,
      cy: HALO_Y,
      r: 26,
      class: "ansHalo"
    });
    halo.style.display = "none";
    gHalo.appendChild(halo);
    svg.insertBefore(gHalo, gTicks); // behind labels

    // hide everything except 0 by default (we’ll reveal via steps)
    const tickNodes = Array.from(gTicks.childNodes);
    for (let i=3; i<tickNodes.length; i++){
      tickNodes[i].style.display = "none";
    }

    // also hide the result label itself until step 4
    resNode.textNode.style.display = "none";

    refs = {
      x0, xA, xR,
      arrowA, arrowB,
      tickNodes,
      aNode, resNode,
      halo,
      HALO_Y,
      showA: () => { for (let i=3; i<6; i++) tickNodes[i].style.display = ""; },
      showResTicksOnly: () => { for (let i=6; i<9; i++) tickNodes[i].style.display = ""; },
      showAnswerLabelAndHalo: () => {
        refs.resNode.textNode.style.display = "";
        refs.halo.style.display = "";
      }
    };

    setPersonX(x0);
  }

  function showArrowLabel(arrow){ arrow.label.style.display = ""; }
  function hideArrow(arrow){
    arrow.path.style.display = "none";
    arrow.label.style.display = "none";
    arrow.tip.style.display = "none";
    arrow.tip.style.opacity = "0";
  }

  function snapArrowToEnd(arrow){
    const { path, tip, x1, x2, y } = arrow;
    path.style.display = "";
    tip.style.display  = "";
    tip.style.opacity  = "1";
    path.setAttribute("x1", String(x1));
    path.setAttribute("y1", String(y));
    path.setAttribute("x2", String(x2));
    path.setAttribute("y2", String(y));
    tip.setAttribute("cx", String(x2));
    tip.setAttribute("cy", String(y));
  }

  function animateLineArrow(arrow, durationMs, token){
    return new Promise((resolve) => {
      const { path, tip, x1, x2, y } = arrow;

      path.style.display = "";
      tip.style.display  = "";
      tip.style.opacity  = "1";

      const start = performance.now();

      function frame(now){
        if (token && token.skip){
          snapArrowToEnd(arrow);
          resolve();
          return;
        }

        const t = clamp((now - start) / durationMs, 0, 1);
        const eased = 1 - Math.pow(1 - t, 2);

        const cx = x1 + (x2 - x1) * eased;

        path.setAttribute("x1", String(x1));
        path.setAttribute("y1", String(y));
        path.setAttribute("x2", String(cx));
        path.setAttribute("y2", String(y));

        tip.setAttribute("cx", String(cx));
        tip.setAttribute("cy", String(y));

        if (t < 1){
          requestAnimationFrame(frame);
        } else {
          snapArrowToEnd(arrow);
          resolve();
        }
      }

      path.setAttribute("x2", String(x1));
      requestAnimationFrame(frame);
    });
  }

  function snapPersonTo(toX){
    stopWalking();
    setPersonX(toX);
    setPersonStill();
  }

  // moveDir controls motion, spriteDir controls which walk frames play.
  function movePerson(fromX, toX, moveDir, spriteDir, durationMs, token){
    return new Promise((resolve) => {
      startWalking(spriteDir);
      const start = performance.now();

      function frame(now){
        if (token && token.skip){
          snapPersonTo(toX);
          resolve();
          return;
        }

        const t = clamp((now - start) / durationMs, 0, 1);
        const eased = 1 - Math.pow(1 - t, 2);
        const cx = fromX + (toX - fromX) * eased;
        setPersonX(cx);

        if (t < 1){
          requestAnimationFrame(frame);
        } else {
          stopWalking();
          setPersonStill();
          resolve();
        }
      }
      requestAnimationFrame(frame);
    });
  }

  function setQuestionText(highlightPart=null){
    const { a, b, op } = Q;
    qMain.innerHTML = questionHTML(a, op, b, highlightPart);
  }

  // ✅ only one line now (no second equation line)
  function setFinalLine(show){
    if (!show){
      qSimpl.classList.remove("show");
      qSimpl.innerHTML = "";
      return;
    }
    const { a, b, op, res } = Q;
    const orig = `${questionHTML(a, op, b, null)} <span class="eq">= <span class="ansPill big">${fmtNumber(res)}</span></span>`;
    qMain.innerHTML = orig;
    qSimpl.classList.remove("show");
    qSimpl.innerHTML = "";
  }

  function updateNavButtons(){
    backBtn.disabled = (stepState <= 0);
    fwdBtn.disabled  = (stepState >= 4);
  }

  function goToStep0(){
    stepState = 0;
    setFinalLine(false);
    setQuestionText(null);

    setPersonStill();
    setPersonX(refs.x0);

    hideArrow(refs.arrowA);
    hideArrow(refs.arrowB);

    // hide ticks beyond 0
    for (let i=3; i<refs.tickNodes.length; i++){
      refs.tickNodes[i].style.display = "none";
    }

    // hide answer label + halo
    refs.resNode.textNode.style.display = "none";
    refs.halo.style.display = "none";

    updateNavButtons();
  }

  async function doStep1(){
    stepState = 1;
    setFinalLine(false);
    setQuestionText("a");
    refs.showA();

    showArrowLabel(refs.arrowA);

    const moveDir1   = (Q.a >= 0) ? "+" : "−";
    const spriteDir1 = "+"; // ALWAYS walk-right for first vector

    const token = beginAnimToken();
    try{
      await Promise.all([
        animateLineArrow(refs.arrowA, ANIM_MS, token),
        movePerson(refs.x0, refs.xA, moveDir1, spriteDir1, ANIM_MS, token)
      ]);
    } finally {
      endAnimToken();
    }

    updateNavButtons();
  }

  async function doStep2(){
    stepState = 2;
    setQuestionText("op");
    setPersonStaticFacingByOp(Q.op);
    updateNavButtons();
  }

  async function doStep3(){
    stepState = 3;
    setQuestionText("b");

    showArrowLabel(refs.arrowB);

    // ✅ reveal the RESULT TICK/POINT, but NOT the answer label/halo yet
    refs.showResTicksOnly();

    const step2 = (Q.op === "+") ? Q.b : -Q.b;
    const moveDir  = (step2 >= 0) ? "+" : "−";

    // sprite direction depends ONLY on operator
    const spriteDir = (Q.op === "+") ? "+" : "−";

    const token = beginAnimToken();
    try{
      await Promise.all([
        animateLineArrow(refs.arrowB, ANIM_MS, token),
        movePerson(refs.xA, refs.xR, moveDir, spriteDir, ANIM_MS, token)
      ]);
    } finally {
      endAnimToken();
    }

    updateNavButtons();
  }

  function doStep4(){
    stepState = 4;

    // ✅ show answer label + halo on the number line
    refs.showAnswerLabelAndHalo();

    // ✅ show final equation with big green answer pill
    setFinalLine(true);

    updateNavButtons();
  }

  async function stepForward(){
    if (stepState >= 4) return;
    if (stepState === 0) return doStep1();
    if (stepState === 1) return doStep2();
    if (stepState === 2) return doStep3();
    if (stepState === 3) return doStep4();
  }

  function stepBack(){
    if (stepState <= 0) return;
    const target = stepState - 1;

    buildScene();
    goToStep0();

    if (target >= 1){
      setQuestionText("a");
      refs.showA();
      showArrowLabel(refs.arrowA);
      snapArrowToEnd(refs.arrowA);
      setPersonX(refs.xA);
      setPersonStill();
      stepState = 1;
    }
    if (target >= 2){
      setQuestionText("op");
      setPersonStaticFacingByOp(Q.op);
      stepState = 2;
    }
    if (target >= 3){
      setQuestionText("b");
      showArrowLabel(refs.arrowB);
      snapArrowToEnd(refs.arrowB);
      setPersonX(refs.xR);
      setPersonStill();
      refs.showResTicksOnly();
      stepState = 3;
    }
    if (target >= 4){
      // not possible here since target = stepState-1, but keep safe
      stepState = 4;
      refs.showAnswerLabelAndHalo();
      setFinalLine(true);
    } else {
      setFinalLine(false);
    }

    updateNavButtons();
  }

  function newQuestion(){
    Q = generateQuestion();
    buildScene();
    goToStep0();
  }

  function resetQuestion(){
    buildScene();
    goToStep0();
  }

  // ----- menus -----
  function closeMenus(){
    toolsMenu.classList.remove("show");
    settingsPanel.classList.remove("show");
  }

  toolsBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const willShow = !toolsMenu.classList.contains("show");
    closeMenus();
    if (willShow) toolsMenu.classList.add("show");
  });

  settingsBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const willShow = !settingsPanel.classList.contains("show");
    closeMenus();
    if (willShow) settingsPanel.classList.add("show");
  });

  document.addEventListener("click", () => closeMenus());
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeMenus(); });

  // difficulty radio handling
  settingsPanel.addEventListener("change", (e) => {
    const t = e.target;
    if (!t || t.name !== "diff") return;
    presetKey = t.value;

    MIN = PRESETS[presetKey].min;
    MAX = PRESETS[presetKey].max;

    // rebuild a fresh question under new constraints
    newQuestion();
  });

  // ----- buttons / keys -----
  newBtn.addEventListener("click", () => newQuestion());
  resetBtn.addEventListener("click", () => resetQuestion());
  backBtn.addEventListener("click", () => stepBack());
  fwdBtn.addEventListener("click", () => {
    if (isAnimating) requestSkip();
    else stepForward();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      if (isAnimating) requestSkip();
      else stepForward();
      return;
    }
    if (e.code === "Space"){ e.preventDefault(); newQuestion(); return; }
    if (e.key === "ArrowRight"){ e.preventDefault(); stepForward(); return; }
    if (e.key === "ArrowLeft"){ e.preventDefault(); stepBack(); return; }
    if (e.key.toLowerCase() === "r"){ e.preventDefault(); resetQuestion(); return; }
  });

  // init
  preloadSprites();
  newQuestion();
})();
</script>
</body>
</html>
